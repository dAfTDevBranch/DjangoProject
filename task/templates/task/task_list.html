{% extends "task/base.html" %}
{% load static %}

{% block title %}Listado de tareas{% endblock %}

{% block content %}
<div class="card">
    <h1 style="margin-top: 0;">Tareas</h1>
    <div class="filters">
        <form class="search-form" method="get">
            <input type="search" name="q" value="{{ query }}" placeholder="Buscar por título o descripción">
            <button class="button secondary" type="submit">Buscar</button>
        </form>
        {% if category %}
            <span class="badge" style="background-color: {{ category.color }}; color: white;">
                Categoría: {{ category.name }}
            </span>
        {% endif %}
        {% if tag %}
            <span class="badge">
                Etiqueta: {{ tag.name }}
            </span>
        {% endif %}
        {% if query %}
            <span class="badge">Resultado de: "{{ query }}"</span>
        {% endif %}
    </div>

    <div style="display:flex; gap:2rem; flex-wrap:wrap; margin-bottom:1.5rem;">
        <div>
            <h2>Categorías</h2>
            <ul style="list-style:none; padding:0; margin:0;">
                <li><a href="{% url 'task_list' %}">Todas</a></li>
                {% for item in categories %}
                    <li>
                        <a href="{% url 'task_list_by_category' item.pk %}">{{ item.name }}</a>
                    </li>
                {% empty %}
                    <li>No hay categorías registradas.</li>
                {% endfor %}
            </ul>
        </div>
        <div>
            <h2>Etiquetas</h2>
            <ul style="list-style:none; padding:0; margin:0;">
                <li><a href="{% url 'task_list' %}">Todas</a></li>
                {% for item in tags %}
                    <li>
                        <a href="{% url 'task_list_by_tag' item.pk %}">{{ item.name }}</a>
                    </li>
                {% empty %}
                    <li>No hay etiquetas registradas.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    {% if page_obj.object_list %}
        <table>
            <thead>
                <tr>
                    <th>Título</th>
                    <th>Categoría</th>
                    <th>Fecha límite</th>
                    <th>Etiquetas</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for task in page_obj.object_list %}
                    <tr>
                        <td><a href="{% url 'task_detail' task.pk %}">{{ task.title }}</a></td>
                        <td>
                            <span class="badge" style="background-color: {{ task.category.color }}; color: white;">
                                {{ task.category.name }}
                            </span>
                        </td>
                        <td>
                            {% if task.due_date %}
                                {{ task.due_date|date:"d/m/Y" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% for tag in task.tags.all %}
                                <span class="badge">{{ tag.name }}</span>
                            {% empty %}
                                Sin etiquetas
                            {% endfor %}
                        </td>
                        <td>
                            {% if task.completed %}
                                <span class="badge completed">Completada</span>
                            {% else %}
                                <span class="badge">Pendiente</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No se encontraron tareas con los filtros actuales.</p>
    {% endif %}

    {% if page_obj.paginator.num_pages > 1 %}
        <div style="margin-top:1.5rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
            {% if page_obj.has_previous %}
                <a class="button secondary" href="?{% if query %}q={{ query }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            {% endif %}
            <span>Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a class="button secondary" href="?{% if query %}q={{ query }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}
